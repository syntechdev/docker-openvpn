#!/bin/bash
## @licence MIT <http://opensource.org/licenses/MIT>
## @author Copyright (C) 2015 Robin Schneider <ypid@riseup.net>

usage ()
{
        echo "
#
#  Usage: use $0 to get the OpenVPN client config for a single user passed as the first parameter
# 
#       * this script requires a minimum of one (1) existing OpenVPN user as it's single parameter
#       
"
}

if [ "$#" == "0" ]
        then usage
        exit 1
else

  if [ -z "$OPENVPN" ]; then
    export OPENVPN="$PWD"
  fi
# Add ability to generate files for non-eng vpn based on environment variable if OVPNENV is set to "non-eng-ovpn_env.sh"
  if [ -z "$OVPNENV" ]; then
    export OVPNENV="ovpn_env.sh"
  fi
  if ! source "$OPENVPN/$OVPNENV"; then
    echo "Could not source $OPENVPN/$OVPNENV ..."
    exit 1
  fi
  if [ -z "$EASYRSA_PKI" ]; then
    export EASYRSA_PKI="$OPENVPN/pki"
  fi

# Generate the OpenVPN client config for this user
  pushd "$EASYRSA_PKI"
  for name in issued/${1}.crt; do
    name=${name%.crt}
    name=${name#issued/}
    if [ "$name" != "$OVPN_CN" ]; then
        ovpn_getclient "$name" separated
        ovpn_getclient "$name" combined-save
    fi
  done
  popd

# package the generated OpenVPN client config in a tarball named for this user 
  pushd ${OPENVPN}/clients/
  tar cvzf ${1}.tgz ${1}/${1}*
  popd

fi
